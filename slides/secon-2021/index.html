<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Model Driven Apps</title>

		<meta name="description" content="">
		<meta name="author" content="Nikolai Ryzhikov">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="../../dist/reset.css">
		<link rel="stylesheet" href="../../dist/reveal.css">
		<!-- <link rel="stylesheet" href="../../dist/theme/black.css" id="theme"> -->
		<link rel="stylesheet" href="../../dist/theme/white.css" id="theme">
		<!-- <link rel="stylesheet" href="../../dist/theme/solarized.css" id="theme"> -->
		<!-- <link rel="stylesheet" href="../../dist/theme/moon.css" id="theme"> -->

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="../../plugin/highlight/monokai.css">
    <style>
     h1, h2, h3, h4 { color: #ea4a35!important; }
     hr {
      border-color: #eee!important;
      border-bottom: none;
      height: 0px
      box-shadow: none;
      outline: none;
     }

     a { color: #4d7099!important; }
     #conflogo {
       position: absolute;
       left: 20px;
       top: 0px;
       width: 150px;
     }
     .reveal .code-wrapper code {
        padding: 1rem;
        border-radius: 0.3rem;
     }
    </style>
	</head>

	<body>

		<div class="reveal">

      <img id="conflogo" src="https://secon.ru/img/smi/secon-logo.png"/>
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

<section data-markdown><script type="text/template">

#### Приложения движимые
### моделями

<small> Николай Рыжиков CTO @ Health Samurai <br/> Секон Пенза Июнь 2021</small>

---


#### CRUD

```js
create_user(db, attrs){
  validate_user(attrs)
  exec("insert into user (colls..) value {{attrs}}")
  notify_user_created(attrs)
}
```
Generalize!
But we need also tables, docs, separated validation, js sdk...

---

#### 2. Model (Metadata)

* annotations
* code analyzis
* put it as a data


---

user.yaml
```yaml
entity: User
table: users
attrs:
  name: {type: string, required: true}
  password: ...
```


---

code:
```
create(cfg, attrs)
  validate(cfg, attrs)
  exec("insert into {{cfg.table}} ({{cfg.cols}}) value {{attrs}}")
  notify(cfg, attrs)

validate(cfg, attrs)
generate_docs(cfg)
generate_database(cfg)
generate_sdk(cfg)
```


---

#### 3. Data Formats

* xml - should die
* yaml* - readable, crazy parser
* json* - well known, too limited, boilerplate
* edn! -  less known, nice balance between yaml and json 

edn = json - syntax noise, + data types, tags  and comments

Additional types:
* symbol - just.some/name
* keyword - :keyword, or :my-ns/keyword
* set #{1 4 5}

Tags:
* #inst "1985-04-12T23:20:50.52Z"
* #uuid "f81d4fae-7dec-11d0-a765-00a0c91e6bf6"


---


example.edn
```edn
{:entity User ;; symbol
 :attrs {:name {:type "string"}
         :password {:type "string"}}}

```


---

#### 4. Names and References

User(address:Address)-*Roles

```edn
{:entity User
 :attrs {:roles   {:ref Role}
         :address {:type Address}}}
```



---

#### 5. Let's add an operation model

operations.edn
```edn
{:type rest/operation
 :path "/User"
 :method "POST""
 :body {:schema User}} <- here we want to compose two models
```

Can we have a one place to put all models?!
Let's organize it as a code:

```
models/
  user.edn
  routes.edn

```


---


#### 6. Re-use models?

Use global names. Introduce packages or namespaces.


```clj

{ns myapp.user
 import #{entity server}

 User {
   :type entity/entity 
   :attrs {...}}
 
 create-user {
   :type server/operation
   :body {:schema myapp.user/User}
   :response {...}}}
```


---

#### 8. Organize models into project

```
src/
 myapp/
   server.edn
   models.edn
libs/
  server.edn
```
  
Use "search paths" approach to load and re-use model libraries!  


---

#### 9. Classification & Tags

Ok we put all entities into data, now we want to
generate all tables. I.e. get all entities.
Let's label all models with "tags" and implement search by tag

```edn
{ns myapp.user
 import #{entity server}

 User {
   :zen/tags #{entity/Entity}
   :attrs {...}
 }
 
 Role {
   :zen/tags #{entity/Entity}
   :attrs {...}
 }

}

```

get-symbol('myapp.user/User)
get-by-tag('entity/Entity) => [...]



---


#### Add schema to validate models?

Data DSL to describe shape of data as a data.

* json-schema (akward global names & refs, keywords semantic, closed world)
* graphql (custom specialized syntax)
* protobuf (too limited)
* DHall
* CUE (custom syntax)

            ===ZEN SCHEMA===

:type => enable keywords, each keyword is a rule!

---

```clj
User
{:zen/tags #{zen/schema}
 :type zen/map
 :require #{:name :password}
 :keys {:name  {:type zen/string 
                :min-length 5
                :regex "^[A-Z].**"}
        :birthDate {:type zen/datetime
                    :in-future true}}}

```

#### :confirms #{} (Open World assumption)

```clj
Resource {
 :zen/tags #{zen/schema}
 :type zen/map
 :keys {:id  {:type zen/string}
        :meta {...}}}

User {
 :zen/tags #{zen/schema}
 :confirms #{Resource} <<-
 :type zen/map
 :keys {:name  {:type zen/string}
        :birthDate {:type zen/datetime}}}

```
Each schema is stand-alone.
Confirm this schema and other schemas from confirms±! 
About unknown keys in a map - all schemas are collaborate.
Schema validates only keys - it knows!
If key was not recognized by any schema -> error.


---

#### Schema & Tags (Composition)

If schema attached to tag, entity with tag validated against this schema

```edn
;; db.edn
persistent {
 :zen/tags #{zen/tag zen/schema}
 :keys {:db/table {:type zen/string}}
}

;; zdoc.edn
entity {
 :zen/tags #{zen/tag zen/schema}
 :keys {:zdoc/comments {:type zen/string}}
}

;; myapp.edn
User {
 :zen/tags #{zen/schema db/persistent zdoc/entity}
 :type zen/map
 :db/table "users"
 :zdoc/comments "User is a ...."
 :keys {:name  {:type zen/string}
        :birthDate {:type zen/datetime}}}

```



---

#### Zen system

[Codebase]  <=>   [Model]

* generalize
* move logic from code to model space

System = models + interpreters


</script></section>


			</div>

		</div>

		<script src="../../dist/reveal.js"></script>
		<script src="../../plugin/zoom/zoom.js"></script>
		<script src="../../plugin/notes/notes.js"></script>
		<script src="../../plugin/search/search.js"></script>
		<script src="../../plugin/markdown/markdown.js"></script>
		<script src="../../plugin/highlight/highlight.js"></script>
		<script>

			// Also available as an ES module, see:
			// https://revealjs.com/initialization/
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
			});

		</script>

	</body>
</html>
